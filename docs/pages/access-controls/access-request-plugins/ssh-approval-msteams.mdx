---
title: Access Requests with Microsoft Teams
description: How to set up Teleport's Microsoft Teams plugin for privilege elevation approvals.
---

This guide will explain how to set up Microsoft Teams to receive Access Request messages
from Teleport. Teleport's Microsoft Teams integration notifies individuals of
Access Requests. Users can then approve and deny Access Requests by following the
message link, making it easier to implement security best practices without
compromising productivity.

## Prerequisites

(!docs/pages/includes/commercial-prereqs-tabs.mdx!)

- A Microsoft Teams License (Microsoft 365 Business).
- Azure console access in the organization/directory holding the Microsoft Teams License.
- An Azure resource group in the same directory. This will  host resources for the the Microsoft Teams Access Request plugin.
  You should have enough permissions to create and edit Azure Bot Services in this resource group.
- Someone with Global Admin rights on the Azure Active Directory that will
  grant permissions to the plugin.
- Someone with the `Teams administrator` role that can approve installation
  requests for Microsoft Teams Apps.

(!/docs/pages/includes/tctl.mdx!)

## Step 1/9. Define RBAC resources

Before you set up the Microsoft Teams plugin, you will need to enable Role Access Requests
in your Teleport cluster. 

(!/docs/pages/includes/plugins/editor-request-rbac.mdx!)

## Step 2/9. Install the Teleport Microsoft Teams plugin

We currently only provide `linux-amd64` binaries. You can also compile these
plugins from source. You can run the plugin from a remote host or your local
development machine.

<Notice scope={["enterprise"]} type="tip">
We recommend installing Teleport plugins on the same host as the Teleport
Proxy Service. This is an ideal location as plugins have a low memory footprint
and will require access to both the public internet and the Teleport Auth Service.
</Notice>

<Tabs>
<TabItem label="Download">
  ```code
  $ curl -L -O https://get.gravitational.com/teleport-access-msteams-v(=teleport.version=)-linux-amd64-bin.tar.gz
  $ tar -xzf teleport-access-msteams-v(=teleport.version=)-linux-amd64-bin.tar.gz
  $ ./teleport-access-msteams/install
  ```
</TabItem>
<TabItem label="From Source">
  To install from source you need `git` and `go` >= (=teleport.golang=)
  installed.

  ```code
  # Check out the teleport-plugins repository
  $ git clone https://github.com/gravitational/teleport-plugins.git
  $ cd teleport-plugins/access/msteams
  $ make
  ```
  
  Place the `teleport-msteams` binary into an appropriate location
  within the system's `PATH`, e.g., `/usr/local/bin`:

  ```code 
  $ mv ./build/teleport-msteams /usr/local/bin
  ```

</TabItem> 
</Tabs>

  Make sure the binary is installed:

  ```code
  $ teleport-msteams version
  teleport-msteams v(=teleport.plugin.version=) git:teleport-msteams-v(=teleport.plugin.version=)-fffffffff go(=teleport.golang=)
  ```

## Step 3/9. Create a user and role for the plugin

(!docs/pages/includes/plugins/rbac.mdx!)

## Step 4/9. Export the access plugin identity

(!docs/pages/includes/plugins/identity-export.mdx!)

The rest of this guide assumes that you have placed any files generated by this
command into `/var/lib/teleport/plugins/msteams` for later reference when
configuring the plugin:

```code
# create a data directory to hold certificate files for the plugin.
$ sudo mkdir -p /var/lib/teleport/plugins/msteams
$ sudo mv auth.* /var/lib/teleport/plugins/msteams
```

## Step 5/9. Register an Azure Bot

The Access Request plugin for Microsoft Teams receives Access Request events from the
Teleport Auth Service, formats them into Microsoft Teams messages, and sends them to the
Microsoft Teams API to post them in your workspace. For this to work, you must register a
new Azure Bot. Azure Bot is a managed service by Microsoft that allows to
develop bots that interact with users through different channels, including
Microsoft Teams.

### Register a new Azure bot

Visit [https://portal.azure.com/#create/Microsoft.AzureBot](https://portal.azure.com/#create/Microsoft.AzureBot)
to create a new bot. Choose the bot handle so you can find the bot later in the Azure console (the bot handle will
not be displayed to the user or used to configure the Microsoft Teams plugin). Also edit the Azure subscription,
the resource group and the bot pricing tier.

In the "Microsoft App ID" section choose "Single Tenant" and "Create new
Microsoft App ID".

![Create Azure Bot](../../../img/enterprise/plugins/msteams/create-azure-bot.png)

### Connect the bot to Microsoft Teams

Once the bot is created, open its resource page on the Azure console and
navigate to the "Channels" tab. Click "Microsoft Teams" and add the Microsoft Teams
channel.

The result should be as follows:

![Add Bot Channel](../../../img/enterprise/plugins/msteams/add-bot-channel.png)

### Obtain information about your Microsoft App

On the bot's "Configuration" tab, copy and keep in a safe place the values of
"Microsoft App ID" and "App Tenant ID".  Those two UUIDs will be used in the
plugin configuration.

Click the "Manage" link next to "Microsoft App ID". This will open the app management view.

![Manage Bot App](../../../img/enterprise/plugins/msteams/manage-bot-app.png)

Then, go to the "Certificates & Secrets" section and choose to create a "New client secret".
Use the "Copy" icon to copy the newly created secret and keep it with the
previously recovered App ID and Tenant ID.

The client secret will be used by the Teleport plugin to authenticate as the bot's app when
searching users and posting messages.

### Specify the permissions used by the app

Still in the app management view ("Configuration", then "Manage" the Microsoft App ID),
go to the "API permissions" tab.

Add the following Microsoft Graph Application permissions:

| Permission name | Reason |
|---|---|
| `AppCatalog.Read.All` | Used to list Teams Apps and check the app is installed. |
| `User.Read.All` | Used to get notification recipients. |
| `TeamsAppInstallation.ReadWriteSelfForUser.All` | Used to initiate communication with a user that never interacted with the Teams App before. |
| `TeamsAppInstallation.ReadWriteSelfForTeam.All` | Used to discover if the app is installed in the Team. |

At this point the app declares the required permissions but those have not been granted.

If you are an admin, click "Grant admin consent for \<directory name\>". If you are not an admin,
contact an admin user to grant the permissions.

![Specify App Permissions](../../../img/enterprise/plugins/msteams/specify-app-permissions.png)

Once permissions have been approved, refresh the page and check the approval status.
The result should be as follows:

![Granted App Permissions](../../../img/enterprise/plugins/msteams/granted-app-permissions.png)

## Step 6/9. Configure the Teleport Microsoft Teams plugin

At this point, the Teleport Microsoft Teams plugin has the credentials it needs to
communicate with your Teleport cluster and Azure APIs, but the app has not been
installed to Microsoft Teams yet.

In this step, you will configure the Microsoft Teams plugin to use the Azure
credentials and generate the Teams App package that will be used to install the
Microsoft Teams App. You will also configure the plugin to notify
the right Microsoft Teams users when it receives an Access Request update.

### Generate a config file and assets

The Teleport Microsoft Teams plugin uses a config file in TOML format.  The `configure`
subcommand generates the directory `/var/lib/teleport/plugins/msteams/assets`
containing the TOML configuration file and an `app.zip` file that will be used
later to add the Teams App into the organization catalog.

```code
$ export AZURE_APPID="your-appid"
$ export AZURE_TENANTID="your-tenantid"
$ export AZURE_APPSECRET="your-appsecret"
$ teleport-msteams configure /var/lib/teleport/plugins/msteams/assets --appID "$AZURE_APPID" --tenantID "$AZURE_TENANTID" --appSecret "$AZURE_APPSECRET"
```

This should result in a config file like the one below:

```toml
(!examples/resources/plugins/teleport-msteams.toml!)
```

Copy the `/var/lib/teleport/plugins/msteams/assets/app.zip` file to your local
computer. You will have to upload it to Microsoft Teams later.

<Admonition type="warning" title="Configure command">
The `configure` command is not idempotent. It generates a new Microsoft Teams
application UUID with each execution. It is not possible to use an `app.zip` and
a TOML configuration generated by two different executions.
</Admonition>

### Edit the config file

Copy the file `/var/lib/teleport/plugins/msteams/assets/teleport-msteams.toml`
to `/etc/teleport-msteams.toml`. You can then edit the copy located in `/etc/`.

**`[teleport]`**

The Microsoft Teams plugin uses this section to connect to the Teleport Auth Service.

<ScopedBlock scope={["oss", "enterprise"]}>

The address and credentials you configure depend on whether your plugin can
access the Auth Service directly:

<Tabs>
  <TabItem label="Connect to the Auth Service"> 
    
Set `addr` to the address and port of your Auth Service. This address must be
reachable from the Teleport Microsoft Teams Plugin.

Set `client_key`, `client_crt`, and `root_cas` to the identity files
generated earlier:

```toml
[teleport]
addr = "localhost:3025"
client_key = "/var/lib/teleport/plugins/msteams/auth.key" # Teleport GRPC client secret key
client_crt = "/var/lib/teleport/plugins/msteams/auth.crt" # Teleport GRPC client certificate
root_cas = "/var/lib/teleport/plugins/msteams/auth.cas"   # Teleport cluster CA certs
```
</TabItem>
  <TabItem label="Connect to the Proxy Service">

Set `addr` to  your Proxy Service address with port `443`.

Set `identity` to the identity file generated earlier:

```toml
[teleport]
addr = "mytenant.teleport.sh:443"
identity = "/var/lib/teleport/plugins/msteams/auth.pem"
```
  </TabItem>
</Tabs>

</ScopedBlock>
<ScopedBlock scope="cloud">

Set `addr` to  your Teleport Cloud tenant address with port `443`.

Set `identity` to the identity file generated earlier:

```toml
[teleport]
addr = "mytenant.teleport.sh:443"
identity = "/var/lib/teleport/plugins/msteams/auth.pem"
```

</ScopedBlock>
 
**`[role_to_recipients]`**

The `role_to_recipients` map configure the users and channels that the
Microsoft Teams plugin will notify when a user requests access to a specific role. When
the Microsoft Teams plugin receives an Access Request from the Auth Service, it will
look up the role being requested and identify the Microsoft Teams users and channels to
notify.

Here is an example of a `role_to_recipients` map:

```toml
[role_to_recipients]
"*" = "alice@example.com"
"dev" = ["alice@example.com", "bob@example.com"]
"dba" = "https://teams.microsoft.com/l/channel/19%3somerandomid%40thread.tacv2/ChannelName?groupId=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&tenantId=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

In the `role_to_recipients` map, each key is the name of a Teleport role. Each
value configures the Teams user (or users) to notify. The value can be a single
string or an array of strings. Each string must be either the email address of
a Microsoft Teams user or a channel URL.

You can find the URL of a channel by opening the channel and clicking the button
"Get link to channel":

![Copy Teams Channel](../../../img/enterprise/plugins/msteams/copy-teams-channel.png)

The `role_to_recipients` map must also include an entry for `"*"`, which the
plugin looks up if no other entry matches a given role name. In the example
above, requests for roles aside from `dev` and `dba` will notify `alice@example.com`.

<Details title="Suggested reviewers">

Users can suggest reviewers when they create an Access Request, e.g.,:

```code
$ tsh request create --roles=dbadmin --reviewers=alice@example.com,ivan@example.com
```

If an Access Request includes suggested reviewers, the Microsoft Teams plugin will add
these to the list of channels to notify. If a suggested reviewer is an email
address, the plugin will look up the the direct message channel for that
address and post a message in that channel.

</Details>

Configure the Microsoft Teams plugin to notify you when a user requests the `editor` role
by adding the following to your `role_to_recipients` config (replace
`TELEPORT_USERNAME` with the email of the user you assigned the `editor-reviewer`
role earlier):

```toml
[role_to_recipients]
"*" = "TELEPORT_USERNAME"
"editor" = "TELEPORT_USERNAME"
```

## Step 7/9. Add and configure the Teams App

### Upload the Teams App

Open Microsoft Teams and go to "Apps", "Manage your apps", then in the additional
choices menu choose "Upload an App".

![Upload Teams App](../../../img/enterprise/plugins/msteams/upload-teams-app.png)

If you're a Teams admin, choose "Upload an app to your org's app catalog".
This will allow you to skip the approval step.
If you're not a Microsoft Teams admin, choose "Submit an app to your org".

Upload the `app.zip` file you generated earlier.

### Approve the Teams App

If you are not a Teams admin and chose "Submit an app to your org",
you will have to ask a Teams admin to approve it.

They can do so by connecting to the
[Teams admin dashboard](https://admin.teams.microsoft.com/policies/manage-apps),
searching "TeleBot", selecting it and choosing "Allow".

![Upload Teams App](../../../img/enterprise/plugins/msteams/allowed-teams-app.png)

### Add the Teams App to a Team

Once the app is approved it should appear in the "Apps built for your org" section.
Add the newly uploaded app to a team. Open the app, click "Add to a team",
choose the "General" channel of your team and click "Set up a bot".

![Add Teams App](../../../img/enterprise/plugins/msteams/add-teams-app.png)

Note: Once an app is added to a team, it can post on all channels.

## Step 8/9. Test the Teams App

Once Teleport is running, you've created the Teams App, and the plugin is
configured, you can now run the plugin and test the workflow.

### Test Microsoft Teams connectivity

Start the plugin in validation mode:

```code
$ teleport-msteams validate <email of your teams account>
```

If everything works fine, the log output should look like this:

```text
teleport-msteams v(=teleport.plugin.version=) go(=teleport.golang=)

 - Checking application xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx status...
 - Application found in the team app store (internal ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
 - User xxxxxx@xxxxxxxxx.xxx found: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
 - Application installation ID for user: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
 - Chat ID for user: 19:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx@unq.gbl.spaces
 - Chat web URL: https://teams.microsoft.com/l/chat/19%3Axxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx%40unq.gbl.spaces/0?tenantId=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
 - Hailing the user...
 - Message sent, ID: XXXXXXXXXXXXX

Check your MS Teams!
```

The plugin should exit and you should have received two messages through Microsoft Teams.

![Validate Bot Message](../../../img/enterprise/plugins/msteams/validate-bot-message.png)

### Start the MS Teams Plugin

After you configured and validated the MS Teams plugin, run the following command to start it.
The `-d` flag will provide debug information to ensure that the plugin can
connect to MS Teams and your Teleport cluster:

```code
$ teleport-msteams start -d
DEBU   DEBUG logging enabled msteams/main.go:120
INFO   Starting Teleport MS Teams Plugin (=teleport.plugin.version=): msteams/app.go:74
DEBU   Attempting GET teleport.example.com:443/webapi/find webclient/webclient.go:129
DEBU   Checking Teleport server version msteams/app.go:242
INFO   MS Teams app found in org app store id:292e2881-38ab-7777-8aa7-cefed1404a63 name:TeleBot msteams/app.go:179
INFO   Preloading recipient data... msteams/app.go:185
INFO   Recipient found, chat found chat_id:19:a8c06deb-aa2b-4db5-9c78-96e48f625aef_a36aec2e-f11c-4219-b79a-19UUUU57de70@unq.gbl.spaces kind:user recipient:jeff@example.com msteams/app.go:195
INFO   Recipient data preloaded and cached. msteams/app.go:198
DEBU   Watcher connected watcherjob/watcherjob.go:121
INFO   Plugin is ready msteams/app.go:227
```

### Create an Access Request

Create an Access Request and check if the plugin works as expected with the
following steps.

(!docs/pages/includes/plugins/create-request.mdx!)

The user you configured earlier to review the request should receive a direct
message from "TeleBot" in Microsoft Teams allowing them to visit a link in the Teleport
Web UI and either approve or deny the request.

### Resolve the request

(!docs/pages/includes/plugins/resolve-request.mdx!)

Once the request is resolved, the Microsoft Teams bot will update the Access Request message
to reflect its new status.

<Admonition title="Auditing Access Requests">

When the Microsoft Teams plugin posts an Access Request notification to a channel, anyone
with access to the channel can view the notification and follow the link. While
users must be authorized via their Teleport roles to review Access Requests, you
should still check the Teleport audit log to ensure that the right users are
reviewing the right requests.

When auditing Access Request reviews, check for events with the type `Access
Request Reviewed` in the Teleport Web UI <ScopedBlock scope={["oss",
"enterprise"]}>and `access_request.review` if reviewing the audit log on the
Auth Service host</ScopedBlock>.

</Admonition>

## Step 9/9. Set up systemd

In production, we recommend starting the Teleport plugin daemon via an init
system like systemd.  Here's the recommended Teleport plugin service unit file
for systemd:

```ini
(!examples/systemd/plugins/teleport-msteams.service!)
```

Save this as `teleport-msteams.service` in either `/usr/lib/systemd/system/` or
another [unit file load
path](https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Unit%20File%20Load%20Path)
supported by systemd.

Enable and start the plugin:

```code
$ sudo systemctl enable teleport-msteams
$ sudo systemctl start teleport-msteams
```

## Next steps

- Read our guides to configuring [Resource Access
    Requests](../access-requests/resource-requests.mdx) and [Role Access
    Requests](../access-requests/role-requests.mdx) so you can get the most out
    of your Access Request plugins.
## Feedback

If you have any issues with this plugin, please create a GitHub issue in our [`gravitational/teleport-plugins`](https://github.com/gravitational/teleport-plugins/issues/new) repo.
